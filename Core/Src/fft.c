#include "fft.h"
#include "adc.h"
#include "tim.h"
#include "hmi.h"
#include "main.h"
#include "math.h"
#include "arm_math.h"
#include "arm_const_structs.h"


uint16_t adc_value[SAMPLENUM];
Wave wave_val[2];
float voltage[FFT_LEN] = { 0.0f };
float fft_output[FFT_LEN * 2] = { 0.0f };
float fft_mag[FFT_LEN / 2] = { 0.0f };
int16_t dft_voltage[1000];
uint8_t fft_flag = 0;


// DAC正弦缓冲区
const short DAC_SIN[200 * 19] = {
  2142,2236,2329,2421,2512,2600,2687,2771,2852,2930,3004,3075,3141,3204,3262,3314,3362,3405,3443,3475,3501,3521,3536,3545,3548,3545,3536,3521,3501,3475,3443,3405,3362,3314,3262,3204,3141,3075,3004,2930,2852,2771,2687,2600,2512,2421,2329,2236,2142,2048,1954,1860,1767,1675,1584,1496,1409,1325,1244,1166,1092,1021,955,892,834,782,734,691,653,621,595,575,560,551,548,551,560,575,595,621,653,691,734,782,834,892,955,1021,1092,1166,1244,1325,1409,1496,1584,1675,1767,1860,1954,2048,2142,2236,2329,2421,2512,2600,2687,2771,2852,2930,3004,3075,3141,3204,3262,3314,3362,3405,3443,3475,3501,3521,3536,3545,3548,3545,3536,3521,3501,3475,3443,3405,3362,3314,3262,3204,3141,3075,3004,2930,2852,2771,2687,2600,2512,2421,2329,2236,2142,2048,1954,1860,1767,1675,1584,1496,1409,1325,1244,1166,1092,1021,955,892,834,782,734,691,653,621,595,575,560,551,548,551,560,575,595,621,653,691,734,782,834,892,955,1021,1092,1166,1244,1325,1409,1496,1584,1675,1767,1860,1954,2048,
  2189,2329,2466,2600,2729,2852,2967,3075,3173,3262,3339,3405,3459,3501,3530,3545,3547,3536,3512,3475,3425,3362,3289,3204,3109,3004,2891,2771,2644,2512,2375,2236,2095,1954,1813,1675,1540,1409,1284,1166,1056,955,863,782,711,653,608,575,555,548,555,575,608,653,711,782,863,955,1056,1166,1284,1409,1540,1675,1813,1954,2095,2236,2375,2512,2644,2771,2891,3004,3109,3204,3289,3362,3425,3475,3512,3536,3547,3545,3530,3501,3459,3405,3339,3262,3173,3075,2967,2852,2729,2600,2466,2329,2189,2048,1907,1767,1630,1496,1367,1244,1129,1021,923,834,757,691,637,595,566,551,549,560,584,621,671,734,807,892,987,1092,1205,1325,1452,1584,1721,1860,2001,2142,2283,2421,2556,2687,2812,2930,3040,3141,3233,3314,3385,3443,3488,3521,3541,3548,3541,3521,3488,3443,3385,3314,3233,3141,3040,2930,2812,2687,2556,2421,2283,2142,2001,1860,1721,1584,1452,1325,1205,1092,987,892,807,734,671,621,584,560,549,551,566,595,637,691,757,834,923,1021,1129,1244,1367,1496,1630,1767,1907,2048,
  2236,2421,2600,2771,2930,3075,3204,3314,3405,3475,3521,3545,3545,3521,3475,3405,3314,3204,3075,2930,2771,2600,2421,2236,2048,1860,1675,1496,1325,1166,1021,892,782,691,621,575,551,551,575,621,691,782,892,1021,1166,1325,1496,1675,1860,2048,2236,2421,2600,2771,2930,3075,3204,3314,3405,3475,3521,3545,3545,3521,3475,3405,3314,3204,3075,2930,2771,2600,2421,2236,2048,1860,1675,1496,1325,1166,1021,892,782,691,621,575,551,551,575,621,691,782,892,1021,1166,1325,1496,1675,1860,2048,2236,2421,2600,2771,2930,3075,3204,3314,3405,3475,3521,3545,3545,3521,3475,3405,3314,3204,3075,2930,2771,2600,2421,2236,2048,1860,1675,1496,1325,1166,1021,892,782,691,621,575,551,551,575,621,691,782,892,1021,1166,1325,1496,1675,1860,2048,2236,2421,2600,2771,2930,3075,3204,3314,3405,3475,3521,3545,3545,3521,3475,3405,3314,3204,3075,2930,2771,2600,2421,2236,2048,1860,1675,1496,1325,1166,1021,892,782,691,621,575,551,551,575,621,691,782,892,1021,1166,1325,1496,1675,1860,2048,
  2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,
  2329,2600,2852,3075,3262,3405,3501,3545,3536,3475,3362,3204,3004,2771,2512,2236,1954,1675,1409,1166,955,782,653,575,548,575,653,782,955,1166,1409,1675,1954,2236,2512,2771,3004,3204,3362,3475,3536,3545,3501,3405,3262,3075,2852,2600,2329,2048,1767,1496,1244,1021,834,691,595,551,560,621,734,892,1092,1325,1584,1860,2142,2421,2687,2930,3141,3314,3443,3521,3548,3521,3443,3314,3141,2930,2687,2421,2142,1860,1584,1325,1092,892,734,621,560,551,595,691,834,1021,1244,1496,1767,2048,2329,2600,2852,3075,3262,3405,3501,3545,3536,3475,3362,3204,3004,2771,2512,2236,1954,1675,1409,1166,955,782,653,575,548,575,653,782,955,1166,1409,1675,1954,2236,2512,2771,3004,3204,3362,3475,3536,3545,3501,3405,3262,3075,2852,2600,2329,2048,1767,1496,1244,1021,834,691,595,551,560,621,734,892,1092,1325,1584,1860,2142,2421,2687,2930,3141,3314,3443,3521,3548,3521,3443,3314,3141,2930,2687,2421,2142,1860,1584,1325,1092,892,734,621,560,551,595,691,834,1021,1244,1496,1767,2048,
  2375,2687,2967,3204,3385,3501,3547,3521,3425,3262,3040,2771,2466,2142,1813,1496,1205,955,757,621,555,560,637,782,987,1244,1540,1860,2189,2512,2812,3075,3289,3443,3530,3545,3488,3362,3173,2930,2644,2329,2001,1675,1367,1092,863,691,584,548,584,691,863,1092,1367,1675,2001,2329,2644,2930,3173,3362,3488,3545,3530,3443,3289,3075,2812,2512,2189,1860,1540,1244,987,782,637,560,555,621,757,955,1205,1496,1813,2142,2466,2771,3040,3262,3425,3521,3547,3501,3385,3204,2967,2687,2375,2048,1721,1409,1129,892,711,595,549,575,671,834,1056,1325,1630,1954,2283,2600,2891,3141,3339,3475,3541,3536,3459,3314,3109,2852,2556,2236,1907,1584,1284,1021,807,653,566,551,608,734,923,1166,1452,1767,2095,2421,2729,3004,3233,3405,3512,3548,3512,3405,3233,3004,2729,2421,2095,1767,1452,1166,923,734,608,551,566,653,807,1021,1284,1584,1907,2236,2556,2852,3109,3314,3459,3536,3541,3475,3339,3141,2891,2600,2283,1954,1630,1325,1056,834,671,575,549,595,711,892,1129,1409,1721,2048,
  2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,2421,2771,3075,3314,3475,3545,3521,3405,3204,2930,2600,2236,1860,1496,1166,892,691,575,551,621,782,1021,1325,1675,2048,
  2466,2852,3173,3405,3530,3536,3425,3204,2891,2512,2095,1675,1284,955,711,575,555,653,863,1166,1540,1954,2375,2771,3109,3362,3512,3545,3459,3262,2967,2600,2189,1767,1367,1021,757,595,549,621,807,1092,1452,1860,2283,2687,3040,3314,3488,3548,3488,3314,3040,2687,2283,1860,1452,1092,807,621,549,595,757,1021,1367,1767,2189,2600,2967,3262,3459,3545,3512,3362,3109,2771,2375,1954,1540,1166,863,653,555,575,711,955,1284,1675,2095,2512,2891,3204,3425,3536,3530,3405,3173,2852,2466,2048,1630,1244,923,691,566,560,671,892,1205,1584,2001,2421,2812,3141,3385,3521,3541,3443,3233,2930,2556,2142,1721,1325,987,734,584,551,637,834,1129,1496,1907,2329,2729,3075,3339,3501,3547,3475,3289,3004,2644,2236,1813,1409,1056,782,608,548,608,782,1056,1409,1813,2236,2644,3004,3289,3475,3547,3501,3339,3075,2729,2329,1907,1496,1129,834,637,551,584,734,987,1325,1721,2142,2556,2930,3233,3443,3541,3521,3385,3141,2812,2421,2001,1584,1205,892,671,560,566,691,923,1244,1630,2048,
  2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,
  2556,3004,3339,3521,3530,3362,3040,2600,2095,1584,1129,782,584,560,711,1021,1452,1954,2466,2930,3289,3501,3541,3405,3109,2687,2189,1675,1205,834,608,551,671,955,1367,1860,2375,2852,3233,3475,3547,3443,3173,2771,2283,1767,1284,892,637,548,637,892,1284,1767,2283,2771,3173,3443,3547,3475,3233,2852,2375,1860,1367,955,671,551,608,834,1205,1675,2189,2687,3109,3405,3541,3501,3289,2930,2466,1954,1452,1021,711,560,584,782,1129,1584,2095,2600,3040,3362,3530,3521,3339,3004,2556,2048,1540,1092,757,575,566,734,1056,1496,2001,2512,2967,3314,3512,3536,3385,3075,2644,2142,1630,1166,807,595,555,691,987,1409,1907,2421,2891,3262,3488,3545,3425,3141,2729,2236,1721,1244,863,621,549,653,923,1325,1813,2329,2812,3204,3459,3548,3459,3204,2812,2329,1813,1325,923,653,549,621,863,1244,1721,2236,2729,3141,3425,3545,3488,3262,2891,2421,1907,1409,987,691,555,595,807,1166,1630,2142,2644,3075,3385,3536,3512,3314,2967,2512,2001,1496,1056,734,566,575,757,1092,1540,2048,
  2600,3075,3405,3545,3475,3204,2771,2236,1675,1166,782,575,575,782,1166,1675,2236,2771,3204,3475,3545,3405,3075,2600,2048,1496,1021,691,551,621,892,1325,1860,2421,2930,3314,3521,3521,3314,2930,2421,1860,1325,892,621,551,691,1021,1496,2048,2600,3075,3405,3545,3475,3204,2771,2236,1675,1166,782,575,575,782,1166,1675,2236,2771,3204,3475,3545,3405,3075,2600,2048,1496,1021,691,551,621,892,1325,1860,2421,2930,3314,3521,3521,3314,2930,2421,1860,1325,892,621,551,691,1021,1496,2048,2600,3075,3405,3545,3475,3204,2771,2236,1675,1166,782,575,575,782,1166,1675,2236,2771,3204,3475,3545,3405,3075,2600,2048,1496,1021,691,551,621,892,1325,1860,2421,2930,3314,3521,3521,3314,2930,2421,1860,1325,892,621,551,691,1021,1496,2048,2600,3075,3405,3545,3475,3204,2771,2236,1675,1166,782,575,575,782,1166,1675,2236,2771,3204,3475,3545,3405,3075,2600,2048,1496,1021,691,551,621,892,1325,1860,2421,2930,3314,3521,3521,3314,2930,2421,1860,1325,892,621,551,691,1021,1496,2048,
  2644,3141,3459,3545,3385,3004,2466,1860,1284,834,584,575,807,1244,1813,2421,2967,3362,3541,3475,3173,2687,2095,1496,987,653,549,691,1056,1584,2189,2771,3233,3501,3530,3314,2891,2329,1721,1166,757,560,608,892,1367,1954,2556,3075,3425,3548,3425,3075,2556,1954,1367,892,608,560,757,1166,1721,2329,2891,3314,3530,3501,3233,2771,2189,1584,1056,691,549,653,987,1496,2095,2687,3173,3475,3541,3362,2967,2421,1813,1244,807,575,584,834,1284,1860,2466,3004,3385,3545,3459,3141,2644,2048,1452,955,637,551,711,1092,1630,2236,2812,3262,3512,3521,3289,2852,2283,1675,1129,734,555,621,923,1409,2001,2600,3109,3443,3547,3405,3040,2512,1907,1325,863,595,566,782,1205,1767,2375,2930,3339,3536,3488,3204,2729,2142,1540,1021,671,548,671,1021,1540,2142,2729,3204,3488,3536,3339,2930,2375,1767,1205,782,566,595,863,1325,1907,2512,3040,3405,3547,3443,3109,2600,2001,1409,923,621,555,734,1129,1675,2283,2852,3289,3521,3512,3262,2812,2236,1630,1092,711,551,637,955,1452,2048,
  2687,3204,3501,3521,3262,2771,2142,1496,955,621,560,782,1244,1860,2512,3075,3443,3545,3362,2930,2329,1675,1092,691,548,691,1092,1675,2329,2930,3362,3545,3443,3075,2512,1860,1244,782,560,621,955,1496,2142,2771,3262,3521,3501,3204,2687,2048,1409,892,595,575,834,1325,1954,2600,3141,3475,3536,3314,2852,2236,1584,1021,653,551,734,1166,1767,2421,3004,3405,3548,3405,3004,2421,1767,1166,734,551,653,1021,1584,2236,2852,3314,3536,3475,3141,2600,1954,1325,834,575,595,892,1409,2048,2687,3204,3501,3521,3262,2771,2142,1496,955,621,560,782,1244,1860,2512,3075,3443,3545,3362,2930,2329,1675,1092,691,548,691,1092,1675,2329,2930,3362,3545,3443,3075,2512,1860,1244,782,560,621,955,1496,2142,2771,3262,3521,3501,3204,2687,2048,1409,892,595,575,834,1325,1954,2600,3141,3475,3536,3314,2852,2236,1584,1021,653,551,734,1166,1767,2421,3004,3405,3548,3405,3004,2421,1767,1166,734,551,653,1021,1584,2236,2852,3314,3536,3475,3141,2600,1954,1325,834,575,595,892,1409,2048,
  2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,
  2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,2771,3314,3545,3405,2930,2236,1496,892,575,621,1021,1675,2421,3075,3475,3521,3204,2600,1860,1166,691,551,782,1325,2048,
  2812,3362,3547,3314,2729,1954,1205,691,555,834,1452,2236,2967,3443,3530,3204,2556,1767,1056,621,584,955,1630,2421,3109,3501,3488,3075,2375,1584,923,575,637,1092,1813,2600,3233,3536,3425,2930,2189,1409,807,551,711,1244,2001,2771,3339,3548,3339,2771,2001,1244,711,551,807,1409,2189,2930,3425,3536,3233,2600,1813,1092,637,575,923,1584,2375,3075,3488,3501,3109,2421,1630,955,584,621,1056,1767,2556,3204,3530,3443,2967,2236,1452,834,555,691,1205,1954,2729,3314,3547,3362,2812,2048,1284,734,549,782,1367,2142,2891,3405,3541,3262,2644,1860,1129,653,566,892,1540,2329,3040,3475,3512,3141,2466,1675,987,595,608,1021,1721,2512,3173,3521,3459,3004,2283,1496,863,560,671,1166,1907,2687,3289,3545,3385,2852,2095,1325,757,548,757,1325,2095,2852,3385,3545,3289,2687,1907,1166,671,560,863,1496,2283,3004,3459,3521,3173,2512,1721,1021,608,595,987,1675,2466,3141,3512,3475,3040,2329,1540,892,566,653,1129,1860,2644,3262,3541,3405,2891,2142,1367,782,549,734,1284,2048,
  2852,3405,3536,3204,2512,1675,955,575,653,1166,1954,2771,3362,3545,3262,2600,1767,1021,595,621,1092,1860,2687,3314,3548,3314,2687,1860,1092,621,595,1021,1767,2600,3262,3545,3362,2771,1954,1166,653,575,955,1675,2512,3204,3536,3405,2852,2048,1244,691,560,892,1584,2421,3141,3521,3443,2930,2142,1325,734,551,834,1496,2329,3075,3501,3475,3004,2236,1409,782,548,782,1409,2236,3004,3475,3501,3075,2329,1496,834,551,734,1325,2142,2930,3443,3521,3141,2421,1584,892,560,691,1244,2048,2852,3405,3536,3204,2512,1675,955,575,653,1166,1954,2771,3362,3545,3262,2600,1767,1021,595,621,1092,1860,2687,3314,3548,3314,2687,1860,1092,621,595,1021,1767,2600,3262,3545,3362,2771,1954,1166,653,575,955,1675,2512,3204,3536,3405,2852,2048,1244,691,560,892,1584,2421,3141,3521,3443,2930,2142,1325,734,551,834,1496,2329,3075,3501,3475,3004,2236,1409,782,548,782,1409,2236,3004,3475,3501,3075,2329,1496,834,551,734,1325,2142,2930,3443,3521,3141,2421,1584,892,560,691,1244,2048,
  2891,3443,3512,3075,2283,1409,757,551,863,1584,2466,3204,3541,3362,2729,1860,1056,595,637,1166,2001,2852,3425,3521,3109,2329,1452,782,549,834,1540,2421,3173,3536,3385,2771,1907,1092,608,621,1129,1954,2812,3405,3530,3141,2375,1496,807,548,807,1496,2375,3141,3530,3405,2812,1954,1129,621,608,1092,1907,2771,3385,3536,3173,2421,1540,834,549,782,1452,2329,3109,3521,3425,2852,2001,1166,637,595,1056,1860,2729,3362,3541,3204,2466,1584,863,551,757,1409,2283,3075,3512,3443,2891,2048,1205,653,584,1021,1813,2687,3339,3545,3233,2512,1630,892,555,734,1367,2236,3040,3501,3459,2930,2095,1244,671,575,987,1767,2644,3314,3547,3262,2556,1675,923,560,711,1325,2189,3004,3488,3475,2967,2142,1284,691,566,955,1721,2600,3289,3548,3289,2600,1721,955,566,691,1284,2142,2967,3475,3488,3004,2189,1325,711,560,923,1675,2556,3262,3547,3314,2644,1767,987,575,671,1244,2095,2930,3459,3501,3040,2236,1367,734,555,892,1630,2512,3233,3545,3339,2687,1813,1021,584,653,1205,2048,
  2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048, 2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048,2930,3475,3475,2930,2048,1166,621,621,1166,2048
};
// DAC余弦缓冲区
const short DAC_COS[200 * 19] = {
  3545,3536,3521,3501,3475,3443,3405,3362,3314,3262,3204,3141,3075,3004,2930,2852,2771,2687,2600,2512,2421,2329,2236,2142,2048,1954,1860,1767,1675,1584,1496,1409,1325,1244,1166,1092,1021,955,892,834,782,734,691,653,621,595,575,560,551,548,551,560,575,595,621,653,691,734,782,834,892,955,1021,1092,1166,1244,1325,1409,1496,1584,1675,1767,1860,1954,2048,2142,2236,2329,2421,2512,2600,2687,2771,2852,2930,3004,3075,3141,3204,3262,3314,3362,3405,3443,3475,3501,3521,3536,3545,3548,3545,3536,3521,3501,3475,3443,3405,3362,3314,3262,3204,3141,3075,3004,2930,2852,2771,2687,2600,2512,2421,2329,2236,2142,2048,1954,1860,1767,1675,1584,1496,1409,1325,1244,1166,1092,1021,955,892,834,782,734,691,653,621,595,575,560,551,548,551,560,575,595,621,653,691,734,782,834,892,955,1021,1092,1166,1244,1325,1409,1496,1584,1675,1767,1860,1954,2048,2142,2236,2329,2421,2512,2600,2687,2771,2852,2930,3004,3075,3141,3204,3262,3314,3362,3405,3443,3475,3501,3521,3536,3545,3548,
  3541,3521,3488,3443,3385,3314,3233,3141,3040,2930,2812,2687,2556,2421,2283,2142,2001,1860,1721,1584,1452,1325,1205,1092,987,892,807,734,671,621,584,560,549,551,566,595,637,691,757,834,923,1021,1129,1244,1367,1496,1630,1767,1907,2048,2189,2329,2466,2600,2729,2852,2967,3075,3173,3262,3339,3405,3459,3501,3530,3545,3547,3536,3512,3475,3425,3362,3289,3204,3109,3004,2891,2771,2644,2512,2375,2236,2095,1954,1813,1675,1540,1409,1284,1166,1056,955,863,782,711,653,608,575,555,548,555,575,608,653,711,782,863,955,1056,1166,1284,1409,1540,1675,1813,1954,2095,2236,2375,2512,2644,2771,2891,3004,3109,3204,3289,3362,3425,3475,3512,3536,3547,3545,3530,3501,3459,3405,3339,3262,3173,3075,2967,2852,2729,2600,2466,2329,2189,2048,1907,1767,1630,1496,1367,1244,1129,1021,923,834,757,691,637,595,566,551,549,560,584,621,671,734,807,892,987,1092,1205,1325,1452,1584,1721,1860,2001,2142,2283,2421,2556,2687,2812,2930,3040,3141,3233,3314,3385,3443,3488,3521,3541,3548,
  3536,3501,3443,3362,3262,3141,3004,2852,2687,2512,2329,2142,1954,1767,1584,1409,1244,1092,955,834,734,653,595,560,548,560,595,653,734,834,955,1092,1244,1409,1584,1767,1954,2142,2329,2512,2687,2852,3004,3141,3262,3362,3443,3501,3536,3548,3536,3501,3443,3362,3262,3141,3004,2852,2687,2512,2329,2142,1954,1767,1584,1409,1244,1092,955,834,734,653,595,560,548,560,595,653,734,834,955,1092,1244,1409,1584,1767,1954,2142,2329,2512,2687,2852,3004,3141,3262,3362,3443,3501,3536,3548,3536,3501,3443,3362,3262,3141,3004,2852,2687,2512,2329,2142,1954,1767,1584,1409,1244,1092,955,834,734,653,595,560,548,560,595,653,734,834,955,1092,1244,1409,1584,1767,1954,2142,2329,2512,2687,2852,3004,3141,3262,3362,3443,3501,3536,3548,3536,3501,3443,3362,3262,3141,3004,2852,2687,2512,2329,2142,1954,1767,1584,1409,1244,1092,955,834,734,653,595,560,548,560,595,653,734,834,955,1092,1244,1409,1584,1767,1954,2142,2329,2512,2687,2852,3004,3141,3262,3362,3443,3501,3536,3548,
  3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,3530,3475,3385,3262,3109,2930,2729,2512,2283,2048,1813,1584,1367,1166,987,834,711,621,566,548,566,621,711,834,987,1166,1367,1584,1813,2048,2283,2512,2729,2930,3109,3262,3385,3475,3530,3548,
  3521,3443,3314,3141,2930,2687,2421,2142,1860,1584,1325,1092,892,734,621,560,551,595,691,834,1021,1244,1496,1767,2048,2329,2600,2852,3075,3262,3405,3501,3545,3536,3475,3362,3204,3004,2771,2512,2236,1954,1675,1409,1166,955,782,653,575,548,575,653,782,955,1166,1409,1675,1954,2236,2512,2771,3004,3204,3362,3475,3536,3545,3501,3405,3262,3075,2852,2600,2329,2048,1767,1496,1244,1021,834,691,595,551,560,621,734,892,1092,1325,1584,1860,2142,2421,2687,2930,3141,3314,3443,3521,3548,3521,3443,3314,3141,2930,2687,2421,2142,1860,1584,1325,1092,892,734,621,560,551,595,691,834,1021,1244,1496,1767,2048,2329,2600,2852,3075,3262,3405,3501,3545,3536,3475,3362,3204,3004,2771,2512,2236,1954,1675,1409,1166,955,782,653,575,548,575,653,782,955,1166,1409,1675,1954,2236,2512,2771,3004,3204,3362,3475,3536,3545,3501,3405,3262,3075,2852,2600,2329,2048,1767,1496,1244,1021,834,691,595,551,560,621,734,892,1092,1325,1584,1860,2142,2421,2687,2930,3141,3314,3443,3521,3548,
  3512,3405,3233,3004,2729,2421,2095,1767,1452,1166,923,734,608,551,566,653,807,1021,1284,1584,1907,2236,2556,2852,3109,3314,3459,3536,3541,3475,3339,3141,2891,2600,2283,1954,1630,1325,1056,834,671,575,549,595,711,892,1129,1409,1721,2048,2375,2687,2967,3204,3385,3501,3547,3521,3425,3262,3040,2771,2466,2142,1813,1496,1205,955,757,621,555,560,637,782,987,1244,1540,1860,2189,2512,2812,3075,3289,3443,3530,3545,3488,3362,3173,2930,2644,2329,2001,1675,1367,1092,863,691,584,548,584,691,863,1092,1367,1675,2001,2329,2644,2930,3173,3362,3488,3545,3530,3443,3289,3075,2812,2512,2189,1860,1540,1244,987,782,637,560,555,621,757,955,1205,1496,1813,2142,2466,2771,3040,3262,3425,3521,3547,3501,3385,3204,2967,2687,2375,2048,1721,1409,1129,892,711,595,549,575,671,834,1056,1325,1630,1954,2283,2600,2891,3141,3339,3475,3541,3536,3459,3314,3109,2852,2556,2236,1907,1584,1284,1021,807,653,566,551,608,734,923,1166,1452,1767,2095,2421,2729,3004,3233,3405,3512,3548,
  3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,3501,3362,3141,2852,2512,2142,1767,1409,1092,834,653,560,560,653,834,1092,1409,1767,2142,2512,2852,3141,3362,3501,3548,
  3488,3314,3040,2687,2283,1860,1452,1092,807,621,549,595,757,1021,1367,1767,2189,2600,2967,3262,3459,3545,3512,3362,3109,2771,2375,1954,1540,1166,863,653,555,575,711,955,1284,1675,2095,2512,2891,3204,3425,3536,3530,3405,3173,2852,2466,2048,1630,1244,923,691,566,560,671,892,1205,1584,2001,2421,2812,3141,3385,3521,3541,3443,3233,2930,2556,2142,1721,1325,987,734,584,551,637,834,1129,1496,1907,2329,2729,3075,3339,3501,3547,3475,3289,3004,2644,2236,1813,1409,1056,782,608,548,608,782,1056,1409,1813,2236,2644,3004,3289,3475,3547,3501,3339,3075,2729,2329,1907,1496,1129,834,637,551,584,734,987,1325,1721,2142,2556,2930,3233,3443,3541,3521,3385,3141,2812,2421,2001,1584,1205,892,671,560,566,691,923,1244,1630,2048,2466,2852,3173,3405,3530,3536,3425,3204,2891,2512,2095,1675,1284,955,711,575,555,653,863,1166,1540,1954,2375,2771,3109,3362,3512,3545,3459,3262,2967,2600,2189,1767,1367,1021,757,595,549,621,807,1092,1452,1860,2283,2687,3040,3314,3488,3548,
  3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,3475,3262,2930,2512,2048,1584,1166,834,621,548,621,834,1166,1584,2048,2512,2930,3262,3475,3548,
  3459,3204,2812,2329,1813,1325,923,653,549,621,863,1244,1721,2236,2729,3141,3425,3545,3488,3262,2891,2421,1907,1409,987,691,555,595,807,1166,1630,2142,2644,3075,3385,3536,3512,3314,2967,2512,2001,1496,1056,734,566,575,757,1092,1540,2048,2556,3004,3339,3521,3530,3362,3040,2600,2095,1584,1129,782,584,560,711,1021,1452,1954,2466,2930,3289,3501,3541,3405,3109,2687,2189,1675,1205,834,608,551,671,955,1367,1860,2375,2852,3233,3475,3547,3443,3173,2771,2283,1767,1284,892,637,548,637,892,1284,1767,2283,2771,3173,3443,3547,3475,3233,2852,2375,1860,1367,955,671,551,608,834,1205,1675,2189,2687,3109,3405,3541,3501,3289,2930,2466,1954,1452,1021,711,560,584,782,1129,1584,2095,2600,3040,3362,3530,3521,3339,3004,2556,2048,1540,1092,757,575,566,734,1056,1496,2001,2512,2967,3314,3512,3536,3385,3075,2644,2142,1630,1166,807,595,555,691,987,1409,1907,2421,2891,3262,3488,3545,3425,3141,2729,2236,1721,1244,863,621,549,653,923,1325,1813,2329,2812,3204,3459,3548,
  3443,3141,2687,2142,1584,1092,734,560,595,834,1244,1767,2329,2852,3262,3501,3536,3362,3004,2512,1954,1409,955,653,548,653,955,1409,1954,2512,3004,3362,3536,3501,3262,2852,2329,1767,1244,834,595,560,734,1092,1584,2142,2687,3141,3443,3548,3443,3141,2687,2142,1584,1092,734,560,595,834,1244,1767,2329,2852,3262,3501,3536,3362,3004,2512,1954,1409,955,653,548,653,955,1409,1954,2512,3004,3362,3536,3501,3262,2852,2329,1767,1244,834,595,560,734,1092,1584,2142,2687,3141,3443,3548,3443,3141,2687,2142,1584,1092,734,560,595,834,1244,1767,2329,2852,3262,3501,3536,3362,3004,2512,1954,1409,955,653,548,653,955,1409,1954,2512,3004,3362,3536,3501,3262,2852,2329,1767,1244,834,595,560,734,1092,1584,2142,2687,3141,3443,3548,3443,3141,2687,2142,1584,1092,734,560,595,834,1244,1767,2329,2852,3262,3501,3536,3362,3004,2512,1954,1409,955,653,548,653,955,1409,1954,2512,3004,3362,3536,3501,3262,2852,2329,1767,1244,834,595,560,734,1092,1584,2142,2687,3141,3443,3548,
  3425,3075,2556,1954,1367,892,608,560,757,1166,1721,2329,2891,3314,3530,3501,3233,2771,2189,1584,1056,691,549,653,987,1496,2095,2687,3173,3475,3541,3362,2967,2421,1813,1244,807,575,584,834,1284,1860,2466,3004,3385,3545,3459,3141,2644,2048,1452,955,637,551,711,1092,1630,2236,2812,3262,3512,3521,3289,2852,2283,1675,1129,734,555,621,923,1409,2001,2600,3109,3443,3547,3405,3040,2512,1907,1325,863,595,566,782,1205,1767,2375,2930,3339,3536,3488,3204,2729,2142,1540,1021,671,548,671,1021,1540,2142,2729,3204,3488,3536,3339,2930,2375,1767,1205,782,566,595,863,1325,1907,2512,3040,3405,3547,3443,3109,2600,2001,1409,923,621,555,734,1129,1675,2283,2852,3289,3521,3512,3262,2812,2236,1630,1092,711,551,637,955,1452,2048,2644,3141,3459,3545,3385,3004,2466,1860,1284,834,584,575,807,1244,1813,2421,2967,3362,3541,3475,3173,2687,2095,1496,987,653,549,691,1056,1584,2189,2771,3233,3501,3530,3314,2891,2329,1721,1166,757,560,608,892,1367,1954,2556,3075,3425,3548,
  3405,3004,2421,1767,1166,734,551,653,1021,1584,2236,2852,3314,3536,3475,3141,2600,1954,1325,834,575,595,892,1409,2048,2687,3204,3501,3521,3262,2771,2142,1496,955,621,560,782,1244,1860,2512,3075,3443,3545,3362,2930,2329,1675,1092,691,548,691,1092,1675,2329,2930,3362,3545,3443,3075,2512,1860,1244,782,560,621,955,1496,2142,2771,3262,3521,3501,3204,2687,2048,1409,892,595,575,834,1325,1954,2600,3141,3475,3536,3314,2852,2236,1584,1021,653,551,734,1166,1767,2421,3004,3405,3548,3405,3004,2421,1767,1166,734,551,653,1021,1584,2236,2852,3314,3536,3475,3141,2600,1954,1325,834,575,595,892,1409,2048,2687,3204,3501,3521,3262,2771,2142,1496,955,621,560,782,1244,1860,2512,3075,3443,3545,3362,2930,2329,1675,1092,691,548,691,1092,1675,2329,2930,3362,3545,3443,3075,2512,1860,1244,782,560,621,955,1496,2142,2771,3262,3521,3501,3204,2687,2048,1409,892,595,575,834,1325,1954,2600,3141,3475,3536,3314,2852,2236,1584,1021,653,551,734,1166,1767,2421,3004,3405,3548,
  3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,3385,2930,2283,1584,987,621,566,834,1367,2048,2729,3262,3530,3475,3109,2512,1813,1166,711,548,711,1166,1813,2512,3109,3475,3530,3262,2729,2048,1367,834,566,621,987,1584,2283,2930,3385,3548,
  3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,3362,2852,2142,1409,834,560,653,1092,1767,2512,3141,3501,3501,3141,2512,1767,1092,653,560,834,1409,2142,2852,3362,3548,
  3339,2771,2001,1244,711,551,807,1409,2189,2930,3425,3536,3233,2600,1813,1092,637,575,923,1584,2375,3075,3488,3501,3109,2421,1630,955,584,621,1056,1767,2556,3204,3530,3443,2967,2236,1452,834,555,691,1205,1954,2729,3314,3547,3362,2812,2048,1284,734,549,782,1367,2142,2891,3405,3541,3262,2644,1860,1129,653,566,892,1540,2329,3040,3475,3512,3141,2466,1675,987,595,608,1021,1721,2512,3173,3521,3459,3004,2283,1496,863,560,671,1166,1907,2687,3289,3545,3385,2852,2095,1325,757,548,757,1325,2095,2852,3385,3545,3289,2687,1907,1166,671,560,863,1496,2283,3004,3459,3521,3173,2512,1721,1021,608,595,987,1675,2466,3141,3512,3475,3040,2329,1540,892,566,653,1129,1860,2644,3262,3541,3405,2891,2142,1367,782,549,734,1284,2048,2812,3362,3547,3314,2729,1954,1205,691,555,834,1452,2236,2967,3443,3530,3204,2556,1767,1056,621,584,955,1630,2421,3109,3501,3488,3075,2375,1584,923,575,637,1092,1813,2600,3233,3536,3425,2930,2189,1409,807,551,711,1244,2001,2771,3339,3548,
  3314,2687,1860,1092,621,595,1021,1767,2600,3262,3545,3362,2771,1954,1166,653,575,955,1675,2512,3204,3536,3405,2852,2048,1244,691,560,892,1584,2421,3141,3521,3443,2930,2142,1325,734,551,834,1496,2329,3075,3501,3475,3004,2236,1409,782,548,782,1409,2236,3004,3475,3501,3075,2329,1496,834,551,734,1325,2142,2930,3443,3521,3141,2421,1584,892,560,691,1244,2048,2852,3405,3536,3204,2512,1675,955,575,653,1166,1954,2771,3362,3545,3262,2600,1767,1021,595,621,1092,1860,2687,3314,3548,3314,2687,1860,1092,621,595,1021,1767,2600,3262,3545,3362,2771,1954,1166,653,575,955,1675,2512,3204,3536,3405,2852,2048,1244,691,560,892,1584,2421,3141,3521,3443,2930,2142,1325,734,551,834,1496,2329,3075,3501,3475,3004,2236,1409,782,548,782,1409,2236,3004,3475,3501,3075,2329,1496,834,551,734,1325,2142,2930,3443,3521,3141,2421,1584,892,560,691,1244,2048,2852,3405,3536,3204,2512,1675,955,575,653,1166,1954,2771,3362,3545,3262,2600,1767,1021,595,621,1092,1860,2687,3314,3548,
  3289,2600,1721,955,566,691,1284,2142,2967,3475,3488,3004,2189,1325,711,560,923,1675,2556,3262,3547,3314,2644,1767,987,575,671,1244,2095,2930,3459,3501,3040,2236,1367,734,555,892,1630,2512,3233,3545,3339,2687,1813,1021,584,653,1205,2048,2891,3443,3512,3075,2283,1409,757,551,863,1584,2466,3204,3541,3362,2729,1860,1056,595,637,1166,2001,2852,3425,3521,3109,2329,1452,782,549,834,1540,2421,3173,3536,3385,2771,1907,1092,608,621,1129,1954,2812,3405,3530,3141,2375,1496,807,548,807,1496,2375,3141,3530,3405,2812,1954,1129,621,608,1092,1907,2771,3385,3536,3173,2421,1540,834,549,782,1452,2329,3109,3521,3425,2852,2001,1166,637,595,1056,1860,2729,3362,3541,3204,2466,1584,863,551,757,1409,2283,3075,3512,3443,2891,2048,1205,653,584,1021,1813,2687,3339,3545,3233,2512,1630,892,555,734,1367,2236,3040,3501,3459,2930,2095,1244,671,575,987,1767,2644,3314,3547,3262,2556,1675,923,560,711,1325,2189,3004,3488,3475,2967,2142,1284,691,566,955,1721,2600,3289,3548,
  3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262, 2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548,3262,2512,1584,834,548,834,1584,2512,3262,3548
};

/**
 * @brief 启动ADC DMA
 * @note 存储于 adc_value 数组中
 */
void FFT_Start_ADC(void)
{
	HAL_ADC_Start_DMA(&hadc1,(uint32_t *)adc_value,SAMPLENUM);
}

/**
 * @brief ADC转换到电压
 * @param voltage 输出电压数组
 */
void Transform_ADC_to_Voltage(float *voltage)
{
  for(uint16_t i = 0; i < SAMPLENUM; i++)
  {
    voltage[i] = adc_value[i] * 3.3f / 4095.0f;
  }
}

/**
 * @brief 设置定时器时钟
 * @param psc_1 预分频值
 * @param arr_1 自动重装载值
 */
void Set_TIM3_Rate(uint32_t psc_1, uint32_t arr_1)
{
  if (psc_1 < 2) psc_1 = 1;
  if (arr_1 < 2) arr_1 = 1;

  uint32_t new_psc = psc_1 - 1;
  uint32_t new_arr = arr_1 - 1;	
  HAL_TIM_Base_Stop(&htim3);

  TIM3->PSC = new_psc;
  TIM3->ARR = new_arr;
  TIM3->CNT = 0;
  TIM3->EGR = TIM_EGR_UG;

  if (HAL_TIM_Base_Start(&htim3) != HAL_OK) { return; }
  HAL_Delay(100);
}

uint16_t Max_Float_WithinRange(float Data[], uint16_t Left, uint16_t Right)
{
    uint16_t i, MaxIndex;
    MaxIndex = Left;
    for (i = Left; i <= Right; ++i)
    {
        if (Data[MaxIndex] < Data[i]) { MaxIndex = i; }
    }
    return MaxIndex;
}

/** 
 * @brief 找到两个最大的数的索引并按照数的大小填充入index中
 */
void Find_Two_Max(float *fft_mag, uint16_t n, uint16_t left, uint16_t right, uint16_t *index)
{
  // 处理区间只有一个元素的情况
  if (left == right)
  {
    index[0] = left;
    index[1] = left;
    return;
  }
  uint16_t max_idx, second_idx;
  float max_val, second_val;
  // 初始化前两个元素
  if (fft_mag[left] >= fft_mag[left + 1])
  {
    max_idx = left;
    max_val = fft_mag[left];
    second_idx = left + 1;
    second_val = fft_mag[left + 1];
  }
  else
  {
    max_idx = left + 1;
    max_val = fft_mag[left + 1];
    second_idx = left;
    second_val = fft_mag[left];
  }
  // 遍历区间剩余元素
  for (uint16_t i = left + 2; i <= right; i++)
  {
    float current = fft_mag[i];
    if (current > max_val)
    {
      // 更新第二大值为原最大值
      second_val = max_val;
      second_idx = max_idx;
      // 更新最大值
      max_val = current;
      max_idx = i;
    }
    else if (current > second_val)
    {
      // 只更新第二大值
      second_val = current;
      second_idx = i;
    }
  }
  // 存储结果
  index[0] = max_idx;
  index[1] = second_idx;
}

/**
 * @brief 填充谐波索引
 */
void fill_index(float fft_mag[], uint16_t len, uint16_t index_3[], uint16_t index_5[], uint16_t index[])
{
  for(uint16_t i = 0; i < 2; i++)
  {
    index_3[i] = 0;
    index_5[i] = 0;

    // 检查3次谐波范围是否有效
    if ((index[i] * 3) >= 2 && (index[i] * 3 + 2) < len)
    {
      index_3[i] = Max_Float_WithinRange(fft_mag, index[i]*3-2, index[i]*3+2);
    }

    // 检查5次谐波范围是否有效
    if((index[i] * 5) >= 2 && (index[i] * 5 + 2) < len)
    {
      index_5[i] = Max_Float_WithinRange(fft_mag, index[i]*5-2, index[i]*5+2);
    }
  }
}

/**
 * @brief 获取最接近的5kHz倍数的频率
 * @param index 频率索引
 * @retval 最接近的5kHz倍数的频率
 */
int16_t Get_Right_Fre(uint16_t index)
{
  // 计算原始频率值：index * 1000 / 1024
  float fre = (float)index * 1000.0f / 1024.0f;
  // 计算最接近的5的倍数
  return (int16_t)(fre / 5.0f + 0.5f) * 5;
}

/**
 * @brief 判断波形类型
 * @param index 频率索引
 * @param index_3 3次谐波索引
 * @param index_5 5次谐波索引
 * @param wave_val 波形类型
 * @param fft_mag 幅度谱
 * @param len 数据长度
 */
void Judge_wave_type(uint16_t index[], uint16_t index_3[], uint16_t index_5[], Wave wave_val[], float fft_mag[], uint16_t len)
{
  // 检查两个主峰值的频率比
  float freq_ratio = (float)index[0] / (float)index[1];
  // 如果频率比在2-4倍之外，认为没有叠加
  if (freq_ratio > 4.0f || freq_ratio < 2.0f)
  {
    for (uint16_t i = 0; i < 2; i++)
    {
      // 如果3次谐波存在且幅度比小于15，判断为三角波
      if (index_3[i] != 0 && fft_mag[index[i]] / fft_mag[index_3[i]] < 15.0f)
      { wave_val[i].type = 1; } // 三角波
      else
      { wave_val[i].type = 0; } // 正弦波
    }
  } 
  else // 可能有频率叠加
  {
    // 确保index[0]是较低频率
    if (index[0] < index[1])
    {
      // 处理较低频率分量
      if (index_3[0] != 0 && index_5[0] != 0 && 
          fft_mag[index[0]] / fft_mag[index_3[0]] > 50.0f &&
          fft_mag[index_3[0]] / fft_mag[index_5[0]] > 2.0f &&
          fft_mag[index[0]] / fft_mag[index_5[0]] < 100.0f)
      { wave_val[0].type = 0; } // 正弦波
      else
      { wave_val[0].type = 1; } // 三角波
      // 处理较高频率分量
      if (index_3[1] != 0 && fft_mag[index[1]] - fft_mag[index_3[1]] < 0.5f)
      {
        if (index_5[1] != 0 && fft_mag[index[1]] / fft_mag[index_5[1]] < 40.0f)
        { wave_val[1].type = 1; } // 三角波
        else
        { wave_val[1].type = 0; } // 正弦波
      }
      else
      {
        if (index_3[1] != 0 && fft_mag[index[1]] / fft_mag[index_3[1]] < 15.0f)
        { wave_val[1].type = 1; } // 三角波 
        else
        { wave_val[1].type = 0; } // 正弦波
      }
    } 
    else    // 如果顺序反了，交换处理
    {
      // 处理较高频率分量
      if (index_3[1] != 0 && index_5[1] != 0 && 
          fft_mag[index[1]] / fft_mag[index_3[1]] > 50.0f &&
          fft_mag[index_3[1]] / fft_mag[index_5[1]] > 2.0f &&
          fft_mag[index[1]] / fft_mag[index_5[1]] < 100.0f)
      { wave_val[1].type = 0; } // 正弦波
      else
      { wave_val[1].type = 1; } // 三角波
      // 处理较低频率分量
      if (index_3[0] != 0 && fft_mag[index[0]] - fft_mag[index_3[0]] < 0.5f)
      {
        if (index_5[0] != 0 && fft_mag[index[0]] / fft_mag[index_5[0]] < 40.0f)
        { wave_val[0].type = 1; } // 三角波
        else
        { wave_val[0].type = 0; } // 正弦波
      }
      else
      {
        if (index_3[0] != 0 && fft_mag[index[0]] / fft_mag[index_3[0]] < 15.0f)
        { wave_val[0].type = 1; } // 三角波
        else
        { wave_val[0].type = 0; } // 正弦波
      }
    }
  }
}

void Act_FFT(float windowedData[], float fft_output[], float fft_mag[], uint16_t len)
{
  float32_t offset_val;
  arm_mean_f32(voltage, len, &offset_val);

  for (uint16_t i = 0; i < len; i++)
  {
    fft_output[2 * i] = windowedData[i] - offset_val;
    fft_output[2 * i + 1] = 0;
  }

  arm_cfft_f32(&arm_cfft_sR_f32_len1024, fft_output , 0 , 1);
  arm_cmplx_mag_f32(fft_output,fft_mag,len/2);

  fft_mag[0] /= len;
  for(uint16_t i = 1; i < len / 2; i++)
  {
    fft_mag[i] /= (len / 2);
  }
}

/**
 * @brief 波形分析主函数
 */
void FFT_Start(float voltage[], float fft_output[], float fft_mag[], uint16_t len, Wave wave_val[])
{
  uint32_t fre_arr, fre_psc;
  uint16_t index[2] = {0};       // 存储两个主峰值的索引
  uint16_t index_3[2] = {0};     // 存储3次谐波索引
  uint16_t index_5[2] = {0};     // 存储5次谐波索引
  // 设置采样频率为1MHz
  fre_psc = 4;
  fre_arr = 21;
  Set_TIM3_Rate(fre_psc, fre_arr);
  float simple_rate = 84000000.0f / (float)fre_psc / (float)fre_arr;
  // 执行FFT
  Transform_ADC_to_Voltage(voltage);
  Act_FFT( voltage,  fft_output,  fft_mag,len);
  // 找到两个主峰值
  Find_Two_Max(fft_mag, len, 2, len-2, index);
  // 确保index[0]对应较低频率
  if(index[0] > index[1])
  {
    uint16_t temp = index[0];
    index[0] = index[1];
    index[1] = temp;
  }  
  // 填充谐波索引
  fill_index(fft_mag, len, index_3, index_5, index);
  // 判断波形类型
  Judge_wave_type(index, index_3, index_5, wave_val, fft_mag, len);
  // 获取精确频率
  wave_val[0].fre = Get_Right_Fre(index[0]);
  wave_val[1].fre = Get_Right_Fre(index[1]);
}

double corr1000_200(int16_t* data,const int16_t* mask)\
{
    double res = 0;
    for (int i = 0; i < 1000; i++)
    {
        res += (data[i] - 2048) * (mask[i % 200] - 2048);
    }
    return res;
}

/**
 * @brief 获得采样的相位
 * @param geted_val 采样值数组
 * @param f 频率
 * @param template_row 模板行
 * @return 相位
 */
double process_frequency(int16_t* geted_val, int f, int template_row)
{
  double sin_corr = corr1000_200(geted_val, DAC_SIN + 200 * template_row);
  double cos_corr = corr1000_200(geted_val, DAC_COS + 200 * template_row);
  double phase_diff = atan2(sin_corr, cos_corr);

  phase_diff = (phase_diff < 0) ? PI-phase_diff : phase_diff;
  return phase_diff;
}

/**
 * @brief 获得两次采样的相位差
 * @param phase_diff 相位差数组
 * @return 相位差
 */
double Get_Delta_Phase( double phase_diff[])
{
  double delta_Phase;
  double temp = phase_diff[0] - phase_diff[1];
  delta_Phase = fabs(temp) < PI ? temp : -temp;
  return delta_Phase;
}

/**
 * @brief 将ADC采样数据转为int16_t
 * @param geted_val 采样值数组
 */
void Transmit_adc_to_int16(int16_t geted_val[])
{
  for (uint16_t i=0;i<1000;i++)
  {
    geted_val[i]=(int16_t)adc_value[i];
  }
}

/**
 * @brief 这里转化为了相差的频率
 * @param delta_phase 相位差数组
 * @param now_fre 当前频率
 * @param delay_time 延迟时间
 * @return 频率差
 */
double Get_Delta_Fre(double delta_phase[], double now_fre, double delay_time)
{
  double now_delta_out_f = delta_phase[1] / delay_time / 2 / PI;
  double now_delta_in_f = delta_phase[0] / delay_time / 2 / PI;
  double delta = now_delta_in_f - now_delta_out_f;
  return delta;
}

/**
 * @brief FFT处理函数
 * @note  主要的处理结果在 fft_mag 和 wave_val 数组中
 */
void FFT_Process(void)
{
  FFT_Start(voltage, fft_output, fft_mag, FFT_LEN, wave_val);
}
